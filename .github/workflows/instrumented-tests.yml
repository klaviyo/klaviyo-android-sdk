# Workflow for running Android instrumented tests across multiple API levels
# Runs on master, release branches, and PRs with specific labels
#
# Optimized to build APKs once, then run tests on multiple emulators in parallel

name: Instrumented Tests

# Required permissions for label management
permissions:
  contents: read
  pull-requests: write

# Trigger conditions
on:
  # Run on pushes to main branches
  push:
    branches:
      - 'master'
      - 'rel/*'

  # Run on PRs when specific labels are added or when labeled PRs are updated
  pull_request:
    types: [ labeled ]

jobs:
  # Build job - compiles APKs once
  build:
    name: Build
    runs-on: ubuntu-22.04

    # Run if: push to branches OR PR with test:all label
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'test:all'))

    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Setup Android Build Environment
        uses: ./.github/actions/setup
        with:
          google-services-json: ${{secrets.GOOGLE_SERVICES_JSON}}

      - name: Configure local.properties for instrumented tests
        run: |
          echo "klaviyoPublicApiKey=$INSTRUMENTED_TEST_PUBLIC_API_KEY" >> local.properties
        env:
          INSTRUMENTED_TEST_PUBLIC_API_KEY: ${{secrets.INSTRUMENTED_TEST_PUBLIC_API_KEY}}

      - name: Build APKs
        run: |
          ./gradlew :sample:assembleDebug :sample:assembleDebugAndroidTest --no-daemon
          # Copy APKs to a flat directory for easier artifact handling
          mkdir -p apks
          cp sample/build/outputs/apk/debug/sample-debug.apk apks/
          cp sample/build/outputs/apk/androidTest/debug/sample-debug-androidTest.apk apks/

      - name: Upload APKs
        uses: actions/upload-artifact@v4
        with:
          name: apks
          path: apks/
          retention-days: 1

  # Test job - runs on multiple API levels in parallel
  test:
    name: Test (API ${{ matrix.api-level }})
    runs-on: ubuntu-22.04
    needs: build

    strategy:
      fail-fast: false
      matrix:
        include:
          # TODO: API 23 disabled due to WorkManager CoroutineWorker.getForegroundInfo crash
          # See: https://github.com/klaviyo/klaviyo-android-sdk/pull/370
          # - api-level: 23
          #   arch: x86
          - api-level: 36
            arch: x86_64

    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Download APKs
        uses: actions/download-artifact@v4
        with:
          name: apks
          path: apks

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Enable KVM group perms
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: AVD cache
        uses: actions/cache@v4
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-${{ matrix.api-level }}-${{ matrix.arch }}

      - name: Create AVD and generate snapshot for caching
        if: steps.avd-cache.outputs.cache-hit != 'true'
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api-level }}
          arch: ${{ matrix.arch }}
          target: ${{ matrix.api-level >= 30 && 'google_apis' || 'default' }}
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: echo "Generated AVD snapshot for caching."

      - name: Run instrumented tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api-level }}
          arch: ${{ matrix.arch }}
          target: ${{ matrix.api-level >= 30 && 'google_apis' || 'default' }}
          force-avd-creation: false
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: |
            echo "Running instrumented tests on API ${{ matrix.api-level }}"
            adb install apks/sample-debug.apk
            adb install -t apks/sample-debug-androidTest.apk

            # Create directory for test results
            mkdir -p test-results

            # Run tests and capture output
            adb shell am instrument -w -r -e class com.klaviyo.sample.OpenedPushTest com.klaviyo.sample.test/androidx.test.runner.AndroidJUnitRunner 2>&1 | tee test-results/raw-output.txt

            # Also pull any on-device test results if available
            adb pull /sdcard/Android/data/com.klaviyo.sample.test/files/ test-results/ 2>/dev/null || true

            echo "Instrumented tests completed"

      - name: Parse test results
        if: always()
        run: |
          # Parse raw instrumentation output into human-readable format
          python3 << 'PARSER'
          import os
          import re
          import sys

          raw_file = "test-results/raw-output.txt"
          summary_file = "test-results/test-summary.txt"
          api_level = "${{ matrix.api-level }}"
          github_summary_file = os.environ.get('GITHUB_STEP_SUMMARY', '')

          try:
              with open(raw_file, 'r') as f:
                  raw_output = f.read()
          except FileNotFoundError:
              print("No test output found")
              sys.exit(0)

          # Parse test results from raw output
          tests = []
          current_test = {}

          for line in raw_output.split('\n'):
              if 'INSTRUMENTATION_STATUS: test=' in line:
                  current_test['name'] = line.split('=', 1)[1].strip()
              elif 'INSTRUMENTATION_STATUS: class=' in line:
                  current_test['class'] = line.split('=', 1)[1].strip()
              elif 'INSTRUMENTATION_STATUS_CODE:' in line:
                  code = line.split(':')[1].strip()
                  if current_test.get('name'):
                      # Code 1 = test starting, 0 = passed, -1/-2 = failed/error
                      if code == '0':
                          current_test['status'] = 'PASSED'
                          tests.append(current_test.copy())
                      elif code not in ['1']:  # 1 is "test starting"
                          current_test['status'] = 'FAILED'
                          tests.append(current_test.copy())
                      current_test = {}
              elif 'INSTRUMENTATION_STATUS: stack=' in line:
                  current_test['error'] = line.split('=', 1)[1].strip()

          # Count results
          passed = sum(1 for t in tests if t.get('status') == 'PASSED')
          failed = sum(1 for t in tests if t.get('status') == 'FAILED')
          total = passed + failed

          # Generate summary
          summary_lines = []
          summary_lines.append(f"Test Results - API {api_level}")
          summary_lines.append("=" * 40)
          summary_lines.append(f"Total: {total} | Passed: {passed} | Failed: {failed}")
          summary_lines.append("")

          for test in tests:
              status_icon = "âœ“" if test.get('status') == 'PASSED' else "âœ—"
              class_name = test.get('class', '').split('.')[-1]
              summary_lines.append(f"  {status_icon} {class_name}.{test.get('name', 'unknown')}")
              if test.get('error'):
                  summary_lines.append(f"      Error: {test['error'][:100]}...")

          summary_lines.append("")
          summary_lines.append("=" * 40)
          summary_lines.append("PASSED" if failed == 0 else "FAILED")

          summary = '\n'.join(summary_lines)
          print(summary)

          # Write summary file
          with open(summary_file, 'w') as f:
              f.write(summary)

          # Write GitHub job summary
          if github_summary_file:
              with open(github_summary_file, 'a') as f:
                  f.write(f"## Instrumented Tests - API {api_level}\n\n")
                  if failed == 0:
                      f.write(f"âœ… **All {total} tests passed**\n\n")
                  else:
                      f.write(f"âŒ **{failed} of {total} tests failed**\n\n")
                  f.write("| Status | Test |\n")
                  f.write("|--------|------|\n")
                  for test in tests:
                      status = "âœ…" if test.get('status') == 'PASSED' else "âŒ"
                      class_name = test.get('class', '').split('.')[-1]
                      f.write(f"| {status} | `{class_name}.{test.get('name', 'unknown')}` |\n")
                  f.write("\n")

          # Exit with failure if any tests failed
          sys.exit(1 if failed > 0 else 0)
          PARSER

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-api-${{ matrix.api-level }}-${{ matrix.arch }}
          path: test-results/
          retention-days: 7

      - name: Send Slack notification on push failure
        if: failure() && github.event_name == 'push'
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            text: "ðŸš¨ Instrumented Tests Failed on ${{ github.event.pull_request.head.ref || github.ref_name }}"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "ðŸš¨ Instrumented Tests Failed\n"
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*Repository:* ${{ github.repository }}\n*Branch:* `${{ github.event.pull_request.head.ref || github.ref_name }}`\n*API Level:* ${{ matrix.api-level }}\n*Architecture:* ${{ matrix.arch }}\n*Commit:* `${{ github.sha }}`\n*Author:* ${{ github.actor }}"
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*Workflow Run:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"

  # Cleanup job - runs after all tests complete
  cleanup:
    name: Cleanup
    runs-on: ubuntu-22.04
    needs: test
    if: always() && (github.event_name == 'pull_request')

    steps:
      - uses: actions/checkout@v4

      - name: Update PR labels
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr edit ${{ github.event.pull_request.number }} --remove-label "test:all"