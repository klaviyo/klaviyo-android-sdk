# A workflow for validating that release branch versions match the version in strings.xml

name: Release Branch Version Check

# Triggers the workflow on pushes to branches matching rel/*
on:
  push:
    branches:
      - 'rel/*'
  pull_request:
    branches:
      - 'rel/*'
      - 'ecm/*'

jobs:
  version-check:
    name: Validate Release Branch Version
    runs-on: ubuntu-22.04

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so the job can access it
      - uses: actions/checkout@v4

      # Extract version from branch name and strings.xml, then compare them
      - name: Validate Version Match
        run: |
          # Extract version from branch name (rel/x.y.z -> x.y.z)
          BRANCH_NAME="${{ github.ref_name }}"
          if [[ $BRANCH_NAME =~ ^rel/(.+)$ ]]; then
            BRANCH_VERSION="${BASH_REMATCH[1]}"
            echo "Branch version: $BRANCH_VERSION"
          else
            echo "Error: Branch name does not match expected pattern rel/*"
            exit 1
          fi

          # Extract version from strings.xml
          STRINGS_VERSION=$(grep -o '<string name="klaviyo_sdk_version_override">[^<]*</string>' sdk/core/src/main/res/values/strings.xml | sed 's/.*>\([^<]*\)<.*/\1/')
          echo "strings.xml version: $STRINGS_VERSION"

          # Compare versions
          if [ "$BRANCH_VERSION" = "$STRINGS_VERSION" ]; then
            echo "✅ Version match confirmed: $BRANCH_VERSION"
          else
            echo "❌ Version mismatch!"
            echo "Branch version: $BRANCH_VERSION"
            echo "strings.xml version: $STRINGS_VERSION"
            echo "Please update sdk/core/src/main/res/values/strings.xml to match the branch version"
            exit 1
          fi