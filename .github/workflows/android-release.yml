# A workflow for validating that release branch versions match the version in strings.xml

name: Release Branch Version Check

# Triggers the workflow on pushes to branches matching rel/*
on:
  push:
    branches:
      - 'rel/*'
      - 'ecm/*'
  pull_request:
    branches:
      - 'rel/*'
      - 'ecm/*'

jobs:
  version-check:
    name: Validate Release Branch Version
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      # Extract version from branch name and strings.xml, then compare them
      - name: Validate Version Match
        run: |
          # Extract version from branch name
          BRANCH_NAME="${{ github.ref_name }}"
          if [[ $BRANCH_NAME =~ ^[a-z]+/(.+)$ ]]; then
            BRANCH_VERSION="${BASH_REMATCH[1]}"
            echo "Branch version: $BRANCH_VERSION"
          else
            echo "Error: branch name does not match expected pattern"
            exit 1
          fi

          # Extract version from strings.xml
          STRINGS_VERSION=$(grep -o '<string name="klaviyo_sdk_version_override">[^<]*</string>' sdk/core/src/main/res/values/strings.xml | sed 's/.*>\([^<]*\)<.*/\1/')
          echo "strings.xml version: $STRINGS_VERSION"

          # Compare versions
          if [ "$BRANCH_VERSION" = "$STRINGS_VERSION" ]; then
            echo "✅ Version match confirmed: $BRANCH_VERSION"
          else
            echo "❌ Version mismatch!"
            echo "Branch version: $BRANCH_VERSION"
            echo "strings.xml version: $STRINGS_VERSION"
            echo "Use ./bump_version.sh to update the version number in this branch (or correct the branch name)."
          
            # Set environment variables for Slack notification
            echo "BRANCH_VERSION=$BRANCH_VERSION" >> $GITHUB_ENV
            echo "STRINGS_VERSION=$STRINGS_VERSION" >> $GITHUB_ENV
            exit 1
          fi

      # Send Slack notification on version mismatch
      - name: Send Slack notification on failure
        if: failure()
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            text: "🚨 Release Branch Version Mismatch Detected"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "🚨 Release Branch Version Mismatch Detected\n"
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*Repository:* ${{ github.repository }}\n*Branch:* `${{ github.ref_name }}`\n*Expected Version:* `${{ env.BRANCH_VERSION }}`\n*strings.xml Version:* `${{ env.STRINGS_VERSION }}`\n*Action:* Please run `./bump_version.sh` to update the version number in this branch (or correct the branch name)."
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*Workflow Run:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"
